---
layout: post
title:  PARSE!  PARSE!  O.K.!  (Apologies to Dr. Bronner)
date:   2004-01-07
tags:   [ technology ]
---

<p><a href="http://diveintomark.org/">Mark Pilgrim</a> had a sidebar link to <a href="http://www.alpha-geek.com/2004/01/02/example_of_hard_to_parse_html.html">an example</a> of why you should use a real HTML parser, instead of a hodgepodge of regular expressions, to strip out unwanted and potentially dangerous tags/attributes from HTML that you receive. This is a topic near and dear to my heart, because: <ol> <li>When I set up <a href="http://wordpirates.com/">Word Pirates</a>, a site that allows anyone to complain about &#8220;pirated words&#8221; whose meanings are being distorted, I didn&#8217;t do anything to filter the HTML that was received from the outside. Days after the site went live, somebody posted a line of Javascript that redirected it to a porn site.</li> <li>It reminds me of one of my pet peeves&#8230;</li> </ol> <p>In my current job, my most recent project involved a conversion script. One of our products uses a GUI generator tied to a particular database system, using a proprietary language to describe how the input forms on the screen would look and what database fields each screen field was connected to. We want to use a new home-grown GUI system, which is (in theory) database-independent and uses an XML-based language (of course) to convey the same information. My predecessor had written a Perl script to convert from one language to to the other, but the script didn&#8217;t do the whole job; my mission was to improve the script where possible, run it over a hundred or so forms, and then manually clean up as many of them as my co-worker could throw at me.</p> <p>The script that landed in my workstation was an inspiring piece of work. When it processed the forms it received as input, it used regular expressions to identify key words and syntactic constructions. Statements in this proprietary language usually ran across multiple lines, so the script resorted to this sort of technique:</p> <pre> foreach ($line) {   # ...   if (/foobar (.*) begin/) {     $foobar_arg = $1;   }   # ...   if ($foobar_arg) {     # ...     $flag = 0 if /foobar end/;   }   # ... } </pre> <p>(Observe how, if someone had written a form in the original language that said <code>foobar(baz) {</code> instead of <code>foobar (baz) {</code>, the script would become quietly confused and output gibberish.)</p> <p>Meanwhile, on the <em>output</em> end, I had a two-hundred-and-thirty-line for-loop, containing a two-hundred-line for-loop, which added little bits of text to three different strings as it navigated through a two-dimensional array of the names of keys of multilevel hashes, and then concatenated these strings into an XML file at the very end. Unless, of course, the input had triggered some obscure bug and the script generated invalid XML. And I was proud of myself for refactoring the script until it <em>only</em> had twenty-six global variables. Etc., etc., etc.</p> <p>This project bore a strange resemblance to one of my first projects at my <em>previous</em> job, where I had to extend a Perl script that took an XML file as input and generated a PostScript page with the same information &#8230; using regular expressions to take apart the XML, instead of using the perfectly adequate XML parser that comes free with Perl, so that an extra space or carriage return would throw it into complete confusion.</p> <p>You see, about thirty years ago, a bunch of smart people realized that they had better things to do than construct and debug such monstrosities every time they had a new language to interpret, so they invented <a href="http://www.gnu.org/software/flex/manual/html_chapter/flex_5.html">lexers</a> and <a href="http://www.gnu.org/software/bison/manual/html_node/Language-and-Grammar.html">parser generators</a>. Every widely-used language has at least a few of these things, free for the taking, that you can use to <em>describe what a language looks like and where to find information in its statements</em>, instead of taking it apart line by line and using regular expressions to perform abominations in the eyes of God and Larry Wall. But hordes of coders out there seem committed to reinventing the flint and steel all by themselves in their own caves, instead of staggering over to the cave that already has a fire going and grunting &#8220;Ogg please borrow Zippo lighter.&#8221; If I had faith in the efficiency of the free market, I would be comforted by the knowledge that as long as so many others were creating these messes, I could make money cleaning up after them, but &#8230; well.</p> <p>Of course, as <a href="http://www.venge.net/graydon/markup-abuse.html">XML hype</a> continues to overtake the world, such convoluted and ignorant use of regular expressions will become rarer and rarer. Instead, we can look forward to convolted and ignorant use of <acronym title="Domain Object Model">DOM</acronym> and <acronym title="Simple API for XML">SAX</acronym>. Rapture!</p></p>

